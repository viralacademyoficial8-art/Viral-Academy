// Viral Academy - Prisma Schema
// Base de datos: PostgreSQL (Supabase)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  GUEST
  STUDENT
  MENTOR
  ADMIN
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  UNPAID
  TRIALING
  INCOMPLETE
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum CourseCategory {
  // New categories
  BOTS
  LIVE_CLASSES
  WEB_PAGES
  EBOOKS
  VIDEO_EDITING
  AI
  MARKETING
  SOCIAL_VIRAL
  // Legacy categories (for backward compatibility)
  CONTENT
  AUTOMATION
  BRAND
  ECOMMERCE
  MINDSET
  BUSINESS
}

enum LiveType {
  MINDSET    // Lunes - Susy
  MARKETING  // Miércoles - Leo
  SPECIAL    // Eventos especiales
}

enum PostCategory {
  ANNOUNCEMENT
  QUESTION
  WIN
  RESOURCE
  GENERAL
}

enum NotificationType {
  SYSTEM
  COURSE
  LIVE
  COMMUNITY
  CERTIFICATE
  BILLING
}

// ============================================
// AUTH & USERS
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  password      String?
  role          Role      @default(STUDENT)
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  profile        Profile?
  accounts       Account[]
  sessions       Session[]
  subscription   Subscription?
  enrollments    Enrollment[]
  lessonProgress LessonProgress[]
  lessonNotes    LessonNote[]
  bookmarks      Bookmark[]
  certificates   Certificate[]
  quizAttempts   QuizAttempt[]
  posts          Post[]
  comments       Comment[]
  likes          Like[]
  reports        Report[]        @relation("ReportedBy")
  auditLogs      AuditLog[]
  notifications  Notification[]
  lessonComments     LessonComment[]
  lessonCommentLikes LessonCommentLike[]

  // Courses created (for mentors)
  coursesCreated Course[]    @relation("CourseCreator")
  livesCreated   LiveEvent[] @relation("LiveCreator")
  replaysCreated Replay[]    @relation("ReplayCreator")

  // Media uploads
  mediaUploads   Media[]     @relation("MediaUploads")

  @@index([email])
  @@index([role])
  @@index([active])
}

model Profile {
  id             String   @id @default(cuid())
  userId         String   @unique
  firstName      String?
  lastName       String?
  displayName    String?
  avatar         String?
  bio            String?  @db.Text
  objective      String?
  level          String?  // beginner, intermediate, advanced
  onboardingDone Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Mentor-specific fields
  title          String?  // e.g., "Founder & Lead Mentor"
  specialties    String[] // e.g., ["Meta Ads", "Viralidad", "IA aplicada"]
  liveDay        String?  // e.g., "Miércoles"
  liveType       String?  // e.g., "MARKETING", "MINDSET"

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// SUBSCRIPTIONS & BILLING
// ============================================

model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @unique
  stripeCustomerId     String             @unique
  stripeSubscriptionId String?            @unique
  stripePriceId        String?
  status               SubscriptionStatus @default(INCOMPLETE)
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stripeCustomerId])
  @@index([status])
}

// ============================================
// COURSE CATEGORIES (Admin Managed)
// ============================================

model CourseCat {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String
  description String?
  icon        String?  // Lucide icon name
  color       String?  // Hex color for badge
  order       Int      @default(0)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  courses Course[]

  @@map("CourseCategories")
  @@index([slug])
  @@index([order])
  @@index([active])
}

// ============================================
// MEDIA LIBRARY (Uploaded Files)
// ============================================

model Media {
  id          String   @id @default(cuid())
  filename    String   // Original filename
  url         String   // URL from Vercel Blob or other storage
  type        String   // MIME type (image/png, image/jpeg, etc.)
  size        Int      // File size in bytes
  folder      String   @default("general") // Folder/category: courses, avatars, resources, etc.
  alt         String?  // Alt text for images
  uploadedBy  String   // User ID who uploaded
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  uploader User @relation("MediaUploads", fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@map("Media")
  @@index([folder])
  @@index([type])
  @@index([uploadedBy])
  @@index([createdAt])
}

// ============================================
// COURSES & CONTENT
// ============================================

model Course {
  id          String         @id @default(cuid())
  slug        String         @unique
  title       String
  description String         @db.Text
  shortDesc   String?
  thumbnail   String?
  coverImage  String?
  level       CourseLevel    @default(BEGINNER)
  category    String         @default("MARKETING")
  categoryId  String?        // New: relation to CourseCategory
  mentorId    String
  published   Boolean        @default(false)
  featured    Boolean        @default(false)
  order       Int            @default(0)
  duration    Int?           // Total en minutos
  outcomes    String[]       // Lo que aprenderás
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relations
  mentor       User       @relation("CourseCreator", fields: [mentorId], references: [id])
  categoryRel  CourseCat? @relation(fields: [categoryId], references: [id])
  modules      Module[]
  resources    Resource[]
  enrollments  Enrollment[]
  bookmarks    Bookmark[]
  quiz         Quiz?
  certificates Certificate[]

  @@index([slug])
  @@index([published])
  @@index([category])
  @@index([categoryId])
  @@index([mentorId])
}

model Module {
  id          String   @id @default(cuid())
  courseId    String
  title       String
  description String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons Lesson[]

  @@index([courseId])
}

model Lesson {
  id          String   @id @default(cuid())
  moduleId    String
  title       String
  description String?
  videoUrl    String?
  duration    Int?     // En minutos
  notes       String?  @db.Text // Markdown
  order       Int      @default(0)
  published   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  module      Module           @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  resources   Resource[]
  progress    LessonProgress[]
  userNotes   LessonNote[]
  bookmarks   Bookmark[]
  comments    LessonComment[]

  @@index([moduleId])
}

model Resource {
  id          String   @id @default(cuid())
  title       String
  description String?
  fileUrl     String
  fileType    String   // pdf, zip, xlsx, etc.
  fileSize    Int?     // En bytes
  courseId    String?
  lessonId    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  course Course? @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lesson Lesson? @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([courseId])
  @@index([lessonId])
}

// ============================================
// PROGRESS & ENROLLMENTS
// ============================================

model Enrollment {
  id         String    @id @default(cuid())
  userId     String
  courseId   String
  startedAt  DateTime  @default(now())
  completedAt DateTime?

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

model LessonProgress {
  id          String    @id @default(cuid())
  userId      String
  lessonId    String
  completed   Boolean   @default(false)
  completedAt DateTime?
  watchTime   Int       @default(0) // En segundos
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
}

model LessonNote {
  id        String   @id @default(cuid())
  userId    String
  lessonId  String
  content   String   @db.Text
  timestamp Int?     // Timestamp del video donde se tomó la nota
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lessonId])
}

// ============================================
// LESSON COMMENTS / DISCUSSIONS
// ============================================

model LessonComment {
  id           String   @id @default(cuid())
  lessonId     String
  authorId     String
  content      String   @db.Text
  parentId     String?  // Para respuestas anidadas
  attachments  Json?    // Array de URLs de archivos adjuntos [{url, type, name, size}]
  pinned       Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  lesson  Lesson          @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  author  User            @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent  LessonComment?  @relation("LessonCommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies LessonComment[] @relation("LessonCommentReplies")
  likes   LessonCommentLike[]

  @@index([lessonId])
  @@index([authorId])
  @@index([parentId])
  @@index([createdAt])
}

model LessonCommentLike {
  id        String   @id @default(cuid())
  userId    String
  commentId String
  createdAt DateTime @default(now())

  user    User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  comment LessonComment  @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId])
  @@index([commentId])
}

model Bookmark {
  id        String   @id @default(cuid())
  userId    String
  courseId  String?
  lessonId  String?
  createdAt DateTime @default(now())

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course? @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lesson Lesson? @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@unique([userId, lessonId])
  @@index([userId])
}

// ============================================
// LIVES & REPLAYS
// ============================================

model LiveEvent {
  id          String    @id @default(cuid())
  title       String
  description String?   @db.Text
  type        LiveType
  mentorId    String
  scheduledAt DateTime
  duration    Int?      // En minutos
  meetingUrl  String?   // Zoom/YouTube link
  thumbnail   String?
  published   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  mentor  User     @relation("LiveCreator", fields: [mentorId], references: [id])
  replays Replay[]

  @@index([scheduledAt])
  @@index([type])
  @@index([published])
}

model Replay {
  id          String   @id @default(cuid())
  liveEventId String?
  title       String
  description String?  @db.Text
  type        LiveType
  mentorId    String
  videoUrl    String
  duration    Int?     // En minutos
  thumbnail   String?
  recordedAt  DateTime
  published   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  liveEvent LiveEvent? @relation(fields: [liveEventId], references: [id], onDelete: SetNull)
  mentor    User       @relation("ReplayCreator", fields: [mentorId], references: [id])

  @@index([type])
  @@index([recordedAt])
  @@index([published])
}

// ============================================
// CERTIFICATES & QUIZZES
// ============================================

model Quiz {
  id        String   @id @default(cuid())
  courseId  String   @unique
  title     String
  questions Json     // Array de preguntas
  passingScore Int   @default(70) // Porcentaje mínimo
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  course   Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  attempts QuizAttempt[]
}

model QuizAttempt {
  id        String   @id @default(cuid())
  userId    String
  quizId    String
  score     Int      // Porcentaje obtenido
  answers   Json     // Respuestas del usuario
  passed    Boolean
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([quizId])
}

model Certificate {
  id               String   @id @default(cuid())
  userId           String
  courseId         String
  verificationCode String   @unique
  studentName      String   // Nombre del estudiante al momento de generar
  courseName       String   // Nombre del curso al momento de generar
  signatureUrl     String?  // URL de la firma del estudiante
  completedAt      DateTime // Fecha de completación del curso
  issuedAt         DateTime @default(now())
  pdfUrl           String?

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([verificationCode])
  @@index([userId])
}

// ============================================
// COMMUNITY
// ============================================

model CommunityCategory {
  id          String @id @default(cuid())
  slug        String @unique
  name        String
  description String?
  icon        String?
  order       Int    @default(0)

  posts Post[]

  @@index([slug])
}

model Post {
  id         String       @id @default(cuid())
  authorId   String
  categoryId String
  title      String
  content    String       @db.Text
  type       PostCategory @default(GENERAL)
  pinned     Boolean      @default(false)
  locked     Boolean      @default(false)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  author   User              @relation(fields: [authorId], references: [id], onDelete: Cascade)
  category CommunityCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  comments Comment[]
  likes    Like[]
  reports  Report[]

  @@index([authorId])
  @@index([categoryId])
  @@index([type])
  @@index([createdAt])
}

model Comment {
  id        String   @id @default(cuid())
  authorId  String
  postId    String
  content   String   @db.Text
  parentId  String?  // Para respuestas anidadas
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  author  User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  post    Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  parent  Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies Comment[] @relation("CommentReplies")
  likes   Like[]

  @@index([postId])
  @@index([authorId])
}

model Like {
  id        String   @id @default(cuid())
  userId    String
  postId    String?
  commentId String?
  createdAt DateTime @default(now())

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post    Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@unique([userId, commentId])
  @@index([postId])
  @@index([commentId])
}

model Report {
  id         String   @id @default(cuid())
  reporterId String
  postId     String
  reason     String
  resolved   Boolean  @default(false)
  createdAt  DateTime @default(now())

  reporter User @relation("ReportedBy", fields: [reporterId], references: [id], onDelete: Cascade)
  post     Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([resolved])
}

// ============================================
// SYSTEM
// ============================================

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  link      String?
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  entity    String
  entityId  String?
  metadata  Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
}

// ============================================
// SETTINGS (para configuración global)
// ============================================

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
}
